-- CUPONES CREACION

CREATE TABLE D_DE_DATOS.CUPONES_DESCUENTO (
	cod_cupon INT  IDENTITY(1,1) PRIMARY KEY,
	cod_cupon_anterior INT NULL,
	cod_usuario INT NOT NULL,
	monto_cupon DECIMAL (18,2) NOT NULL,
	fecha_alta_cupon DATETIME2(3) NOT NULL,
	fecha_vencimiento_cupon DATETIME2(3) NOT NULL,
	cod_tipo_cupon INT NOT NULL,
	FOREIGN KEY (cod_usuario) REFERENCES D_DE_DATOS.usuarios,
	FOREIGN KEY (cod_tipo_cupon) REFERENCES D_DE_DATOS.tipos_cupones
);


CREATE TABLE D_DE_DATOS.RECLAMOS_CUPON (
	cod_reclamo INT NOT NULL,
	cod_cupon INT NOT NULL,
	FOREIGN KEY (cod_reclamo) REFERENCES D_DE_DATOS.reclamos,
	FOREIGN KEY (cod_cupon) REFERENCES D_DE_DATOS.cupones_descuento,
	PRIMARY KEY (cod_reclamo, cod_cupon)
);

CREATE TABLE D_DE_DATOS.PEDIDOS_CUPON (
	cod_pedido INT NOT NULL,
	cod_cupon INT NOT NULL,
	FOREIGN KEY (cod_pedido) REFERENCES D_DE_DATOS.pedidos,
	FOREIGN KEY (cod_cupon) REFERENCES D_DE_DATOS.cupones_descuento,
	PRIMARY KEY (cod_pedido, cod_cupon)
);


--CUPONES MIGRACION 

	INSERT INTO D_DE_DATOS.CUPONES_DESCUENTO(cod_cupon_anterior,cod_usuario,monto_cupon,fecha_alta_cupon,fecha_vencimiento_cupon,cod_tipo_cupon)
	SELECT DISTINCT
		M.CUPON_NRO,
		U.cod_usuario,
		M.CUPON_MONTO,
		M.CUPON_FECHA_ALTA,
		M.CUPON_FECHA_VENCIMIENTO,
		T.cod_tipo_cupon
	FROM gd_esquema.Maestra
			INNER JOIN D_DE_DATOS.USUARIOS U ON M.USUARIO_DNI = U.DNI_usuario 
			INNER JOIN D_DE_DATOS.TIPOS_CUPONES T ON M.CUPON_TIPO = T.desc_tipo_cupon
	WHERE CUPON_NRO IS NOT NULL
	UNION
	SELECT DISTINCT 
		M.CUPON_RECLAMO_NRO,
		U.cod_usuario,
		M.CUPON_RECLAMO_MONTO,
		M.CUPON_RECLAMO_FECHA_ALTA,
		M.CUPON_RECLAMO_FECHA_VENCIMIENTO,
		T.cod_tipo_cupon
	FROM gd_esquema.Maestra
			INNER JOIN D_DE_DATOS.USUARIOS U ON M.USUARIO_DNI = U.DNI_usuario 
			INNER JOIN D_DE_DATOS.TIPOS_CUPONES T ON M.CUPON_RECLAMO_TIPO = T.desc_tipo_cupon
	WHERE CUPON_RECLAMO_NRO IS NOT NULL;

---

	INSERT INTO D_DE_DATOS.PEDIDOS_CUPON(cod_pedido,cod_cupon)  
	SELECT DISTINCT
		PE.cod_pedido,
		C.cod_cupon
	FROM gd_esquema.Maestra
		INNER JOIN D_DE_DATOS.PEDIDOS PE ON M.PEDIDO_NRO = PE.cod_pedido
		INNER JOIN D_DE_DATOS.CUPONES_DESCUENTO C ON M.CUPON_NRO = C.cod_cupon_anterior
	WHERE PEDIDO_NRO IS NOT NULL AND RECLAMO_NRO IS NULL AND CUPON_NRO IS NOT NULL

---


	INSERT INTO D_DE_DATOS.RECLAMOS_CUPON(cod_reclamo,cod_cupon)
	SELECT DISTINCT
		R.cod_reclamo,
		C.cod_cupon
	FROM gd_esquema.Maestra
		INNER JOIN D_DE_DATOS.RECLAMOS R ON M.RECLAMO_NRO = R.cod_reclamo
		INNER JOIN D_DE_DATOS.CUPONES_DESCUENTO C ON M.CUPON_RECLAMO_NRO = C.cod_cupon_anterior
	WHERE RECLAMO_NRO IS NOT NULL AND CUPON_RECLAMO_NRO IS NOT NULL;
